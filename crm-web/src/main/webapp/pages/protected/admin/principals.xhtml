<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:p="http://primefaces.org/ui"
	template="/WEB-INF/templates/default.xhtml">
	<ui:define name="content">
		<script type="text/javascript">
			function modalGrupoUsuarios() {
				$('#myModal').modal('show');
			}
			function myModalNovoGrupoUsuarios()
			{
				$('#myModalNovoGrupoUsuarios').modal('show');
			}
			function selecionarGrupoUsuarios() {
				debugger
				var table = $('#regPrincipals\\:grupoUsuariosDataTable').DataTable();
				var id = table.row('.selected').data()[0];
				var desc = table.row('.selected').data()[1];
				$('#regPrincipals\\:grupo').val(id);
				$('#regPrincipals\\:grupo_desc').val(desc);
				$('#myModal').modal('hide');
			}
			function grupoUsuariosDataTable()
			{
				var table = $('#regPrincipals\\:grupoUsuariosDataTable').DataTable();
				$('#regPrincipals\\:grupoUsuariosDataTable tbody').on(
						'click',
						'tr',
						function() {
							if ($(this).hasClass('selected')) {
								$(this).removeClass('selected');
							} else {
								table.$('tr.selected').removeClass(
										'selected');
								$(this).addClass('selected');
							}
						});
			}
			$(document).ready(
					function() {
						var table2 = $('#regPrincipals\\:principalsDataTable').DataTable();

						$('#regPrincipals\\:principalsDataTable tbody').on(
								'click',
								'tr',
								function() {
									if ($(this).hasClass('selected')) {
										$(this).removeClass('selected');
									} else {
										table2.$('tr.selected').removeClass(
												'selected');
										$(this).addClass('selected');
									}
								});
						grupoUsuarios();
						grupoUsuariosDataTable();
					});
			function grupoUsuarios() {
				var table3 = $('#regPrincipals\\:grupoUsuariosLeadDataTable')
						.DataTable();
				$('#regPrincipals\\:grupoUsuariosLeadDataTable tbody')
						.on(
								'click',
								'tr',
								function() {
									if ($(this).hasClass('selected')) {
										$(this).removeClass('selected');
									} else {
										table3.$('tr.selected').removeClass(
												'selected');
										$(this).addClass('selected');
									}
								});
			}
			$(window).load(function() {
				jsf.ajax.addOnEvent(function(data) {
					if (data.status == "success") {
						debugger
						grupoUsuarios();
// 						grupoUsuariosDataTable();
					}
				})
			});
		</script>

		<h1>Cadastro de Usuários</h1>

		<h:form id="regPrincipals" enctype="multipart/form-data">
			<h:panelGrid columns="2" columnClasses="rightColumn,leftColumn">
				<h:panelGrid>
					<p:graphicImage
						value="#{salvarPrincipals.carregaImagem(newPrincipal.imagem)}"
						cache="false" width="150px" height="200px" rendered="#{salvarPrincipals.imagemCarregada()}"/>
					<br/>
					<p:graphicImage
						value="#{salvarPrincipals.carregaImagem(newPrincipal.assinaturaEmail)}"
						cache="false" width="300px" height="200px" rendered="#{salvarPrincipals.assinaturaCarregada()}"/>
				</h:panelGrid>
				<h:panelGrid>
					<h:outputLabel for="usuario" value="Nome de Usuário:" />
					<h:inputText id="usuario" value="#{newPrincipal.principalID}" disabled="#{!loginBean.isCallerInRole('ADMIN')}"/>
					<h:message for="usuario" errorClass="invalid" />
					<h:outputLabel for="senha" value="Senha:" />
					<h:inputSecret id="senha" value="#{newPrincipal.password}"/>
					<h:message for="senha" errorClass="invalid" />
					<h:outputLabel for="nome" value="Nome:" />
					<h:inputText id="nome" value="#{newPrincipal.nome}" disabled="#{!loginBean.isCallerInRole('ADMIN')}"/>
					<h:message for="nome" errorClass="invalid" />
					<h:outputLabel for="email" value="Email:" />
					<h:inputText id="email" value="#{newPrincipal.email}" disabled="#{!loginBean.isCallerInRole('ADMIN')}"/>
					<h:message for="email" errorClass="invalid" />
					<h:outputLabel for="role" value="Nivel de acesso:" />
					<h:selectOneMenu id="role" value="#{newPrincipal.role.role}" disabled="#{!loginBean.isCallerInRole('ADMIN')}">
						<f:selectItem itemValue="USER" itemLabel="Usuário" />
						<f:selectItem itemValue="ADMIN" itemLabel="Administrador" />
					</h:selectOneMenu>
					<h:message for="role" errorClass="invalid" />
					<h:outputLabel for="foto" value="Foto:" />
					<h:inputFile id="foto" value="#{newPrincipal.imagemPart}">
						<f:validator binding="#{fileUploadValidator}"/>
					</h:inputFile>
					<h:outputLabel for="assinatura" value="Assinatura:" />
					<h:inputFile id="assinatura" value="#{newPrincipal.assinaturaPart}">
						<f:validator binding="#{fileUploadValidator}"/>
					</h:inputFile>
					<br />
					<h:outputLabel for="grupo" value="Grupo:" />
					<h:panelGroup>
						<h:inputText id="grupo"
							value="#{newPrincipal.grupoUsuariosSelecionado.id}" />
						<h:graphicImage library="images" name="magnifying.png"
							onclick="javascript:modalGrupoUsuarios()" />
						<h:inputText id="grupo_desc" disabled="true" style="border:none;background:white;"/>
					</h:panelGroup>
					<h:message for="grupo" errorClass="invalid" />
					<br />
					<h:commandButton id="adicionarGrupoUsuarios"
						disabled="#{!loginBean.isCallerInRole('ADMIN')}"
						action="#{salvarPrincipals.adicionarGrupoUsuarios(newPrincipal.grupoUsuariosSelecionado.id)}"
						value="Adicionar">
						<f:ajax execute="regPrincipals:grupo"
							render="regPrincipals:gruposUsuariosPanelGrid" />
					</h:commandButton>
				</h:panelGrid>
			</h:panelGrid>
			<h:panelGrid id="gruposUsuariosPanelGrid">
				<br/>
				<h:panelGroup rendered="#{empty newPrincipal.gruposUsuarios}">
					<em>Nenhum Grupo registrado.</em>
				</h:panelGroup>
				<h:dataTable id="grupoUsuariosLeadDataTable" var="_grupoUsuarios"
					value="#{newPrincipal.gruposUsuarios}"
					rendered="#{not empty newPrincipal.gruposUsuarios}" styleClass="table"
					width="100%" style="display:inline-table"
					headerClass="table-header"
					rowClasses="table-odd-row,table-even-row">
					<h:column>
						<f:facet name="header">Id</f:facet>
		                <h:outputText value="#{_grupoUsuarios.grupoUsuarios.id}"/>
	            </h:column>
					<h:column>
						<f:facet name="header">Descrição</f:facet>
	                	<h:outputText value="#{_grupoUsuarios.grupoUsuarios.descricao}"/>
	            </h:column>
				</h:dataTable>
			</h:panelGrid>
			<br />
			<h:commandButton id="salvar" action="#{salvarPrincipals.salvar}"
				value="Salvar" />

		<h2>Usuários</h2>
		<h:panelGroup rendered="#{empty principals}">
			<em>Nenhum usuário registrado.</em>
		</h:panelGroup>
		<h:dataTable id="principalsDataTable" var="_principal"
			value="#{principals}" rendered="#{not empty principals}"
			styleClass="table" headerClass="table-header"
			rowClasses="table-odd-row,table-even-row">
			<h:column>
				<f:facet name="header">Id</f:facet>
                <h:outputText value="#{_principal.id}"/>
            </h:column>
			<h:column>
				<f:facet name="header">Nome</f:facet>
                <h:outputText value="#{_principal.principalID}"/>
            </h:column>
			<h:column>
				<f:facet name="header">Nivel de acesso</f:facet>
                <h:outputText value="#{_principal.role.role}"/>
            </h:column>
			<h:column>
				<f:facet name="header"></f:facet>
				<h:outputLink value="Excluir" />
			</h:column>
			<h:column>
				<f:facet name="header"></f:facet>
				<h:commandLink value="Editar"
					action="#{salvarPrincipals.editar(_principal)}">
				</h:commandLink>
			</h:column>
		</h:dataTable>
		<!-- Modal -->
		<div id="myModal" class="modal fade" role="dialog">
			<div class="modal-dialog">
				<!-- Modal content-->
				<div class="modal-content" style="display:inline-block;">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">X</button>
						<h4 class="modal-title">Selecione o grupo de usuários</h4>
					</div>
					<div class="modal-body">
						<h2>Grupos de usuários</h2>
						<h:panelGrid id="grupoUsuariosPanelGrid">
							<h:panelGroup rendered="#{empty gruposUsuarios}">
								<em>Nenhum Grupo registrado.</em>
								<h:outputLink value="javascript:myModalNovoGrupoUsuarios()">
									<h:outputText value="Novo"/>
								</h:outputLink>
							</h:panelGroup>
							<h:dataTable id="grupoUsuariosDataTable" var="_grupoUsuarios"
								value="#{gruposUsuarios}" rendered="#{not empty gruposUsuarios}"
								styleClass="table" headerClass="table-header"
								rowClasses="table-odd-row,table-even-row">
								<h:column>
									<f:facet name="header">Id</f:facet>
					                <h:outputText value="#{_grupoUsuarios.id}"/>
					            </h:column>
								<h:column>
									<f:facet name="header">Descrição</f:facet>
					                <h:outputText value="#{_grupoUsuarios.descricao}"/>
					            </h:column>
							</h:dataTable>
						</h:panelGrid>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary"
							onclick="javascript:selecionarGrupoUsuarios()">Selecionar</button>
						<button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
					</div>
				</div>
			</div>
		</div>
		<!-- Modal -->
		<div id="myModalNovoGrupoUsuarios" class="modal fade" role="dialog">
			<div class="modal-dialog">
				<!-- Modal content-->
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">X</button>
						<h4 class="modal-title">Novo grupo de usuários</h4>
					</div>
					<div class="modal-body">
						<h2>Grupos de usuários</h2>
						<h:form id="regGrupoUsuarios">
						<h:panelGrid>
				        	<h:outputLabel for="descricao" value="Descrição:" />
				            <h:inputText id="descricao" value="#{newGrupoUsuarios.descricao}" />
				            <h:message for="descricao" errorClass="invalid" />
				            <br/>
				            <h:commandButton id="salvar"
				               action="#{salvarGrupoUsuarios.salvar}" value="Salvar">
				               <f:ajax execute="regGrupoUsuarios:descricao" render="regGrupoUsuarios:descricao regPrincipals:grupoUsuariosPanelGrid"/>
			                </h:commandButton>
						</h:panelGrid>
				      </h:form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
					</div>
				</div>
			</div>
		</div>
		</h:form>
	</ui:define>
</ui:composition>