<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
   xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
   xmlns:f="http://xmlns.jcp.org/jsf/core"
   xmlns:h="http://xmlns.jcp.org/jsf/html"
   template="/WEB-INF/templates/default.xhtml">
   <ui:define name="content">
   <script type="text/javascript">
   $(window)
	.load(
			function() {
				jsf.ajax
						.addOnEvent(function(data) {
							if (data.status == "success") {
								debugger
								if (data.source.id.indexOf("produtosPropostaCommandLink") > -1) {
									myModalProdutosProposta();
								} else if(data.source.id.indexOf("modulosDoProdutoPropostaCommandLink") > -1) {
									myModalModulosDoProdutoProposta();
								}
							}
						})
			});
   $(document).ready(function() {
	    var table = $('#regProposta\\:propostaDataTable').DataTable();
	 
	    $('#regProposta\\:propostaDataTable tbody').on( 'click', 'tr', function () {
	        if ( $(this).hasClass('selected') ) {
	            $(this).removeClass('selected');
	        }
	        else {
	            table.$('tr.selected').removeClass('selected');
	            $(this).addClass('selected');
	        }
	    } );
	    var table2 = $('#leadsDataTable').DataTable();
	 
	    $('#leadsDataTable tbody').on( 'click', 'tr', function () {
	        if ( $(this).hasClass('selected') ) {
	            $(this).removeClass('selected');
	        }
	        else {
	            table2.$('tr.selected').removeClass('selected');
	            $(this).addClass('selected');
	        }
	    } );
	    myModalProdutosProposta();
	} );
   function myModalProdutosProposta()
   {
	   var table3 = $('#regProposta\\:produtoPropostaDataTable').DataTable();
		 
	    $('#regProposta\\:produtoPropostaDataTable tbody').on( 'click', 'tr', function () {
	        if ( $(this).hasClass('selected') ) {
	            $(this).removeClass('selected');
	        }
	        else {
	            table3.$('tr.selected').removeClass('selected');
	            $(this).addClass('selected');
	        }
	    } );
   }
   function myModalModulosDoProdutoProposta()
   {
	   var table3 = $('#modulosDoProdutoPropostaDataTable').DataTable();
		 
	    $('#modulosDoProdutoPropostaDataTable tbody').on( 'click', 'tr', function () {
	        if ( $(this).hasClass('selected') ) {
	            $(this).removeClass('selected');
	        }
	        else {
	            table3.$('tr.selected').removeClass('selected');
	            $(this).addClass('selected');
	        }
	    } );
   }
   function modalModulosDoProdutoProposta()
   {
	   $('#myModalModulosDoProdutoProposta').modal('show');
   }
   function modalProdutosProposta()
   {
	   $('#myModalProdutosProposta').modal('show');
   }
   function modalLead()
   {
	   $('#myModalLeadProposta').modal('show');
   }
   function selecionarLead() {
		var table = $('#leadsDataTable').DataTable();
		var id = table.row('.selected').data()[0];
		$('#regProposta\\:lead').val(id);
		$('#myModalLeadProposta').modal('hide');
	}
   </script>
   
      <h1>Nova Proposta</h1>

      <h:form id="regProposta">
		<h:panelGrid>
			<h:outputLabel for="descricao" value="Descrição:" />
            <h:inputText id="descricao" value="#{newProposta.descricao}" />
            <h:message for="descricao" errorClass="invalid" />
            <h:outputLabel for="validade" value="Validade:" />
		      <h:selectOneMenu id="validade" value="#{newProposta.validade}">
		      	<f:selectItem itemLabel="10 dias" itemValue="10"/>
		      	<f:selectItem itemLabel="20 dias" itemValue="20"/>
		      	<f:selectItem itemLabel="30 dias" itemValue="30"/>
		      </h:selectOneMenu>
            <h:outputLabel for="lead" value="Conta:" />
			<h:panelGroup>
				<h:inputText id="lead" value="#{newProposta.lead.id}" />
				<h:graphicImage library="images" name="magnifying.png"
					onclick="javascript:modalLead()" />
			</h:panelGroup>
            <br/>
         
	 		<ui:include src="/pages/protected/user/_produtomodulosselecionados.xhtml">
				<ui:param name="proposta" value="#{newProposta}" />
		 	</ui:include>
		 	<ui:include src="/pages/protected/user/cotacao.xhtml">
				<ui:param name="proposta" value="#{newProposta}" />
		 	</ui:include>
		 	<h:commandButton id="salvar" action="#{salvarProposta.salvar}" value="Salvar"/>
         </h:panelGrid>
	 
      <br/>      
      <h2>Propostas</h2>
      <h:panelGroup rendered="#{empty propostas}">
         <em>Nenhuma Proposta registrada.</em>
      </h:panelGroup>
      <h:dataTable id="propostaDataTable" var="_proposta" value="#{propostas}"
		rendered="#{not empty propostas}"
		styleClass="table"
		 headerClass="table-header"
		 rowClasses="table-odd-row,table-even-row">
         <h:column>
            <f:facet name="header">Id</f:facet>
                <h:outputText value="#{_proposta.id}"/>
            </h:column>
         <h:column>
            <f:facet name="header">Descrição</f:facet>
                <h:outputText value="#{_proposta.descricao}"/>
            </h:column>
         <h:column>
         	<f:facet name="header"></f:facet>
			<h:commandLink id="produtosPropostaCommandLink" value="Produtos" action="#{salvarProposta.setProdutoModulosSelecionados(_proposta.produtosModulosSelecionados)}" onclick="javascript:modalProdutosProposta()">
				<f:ajax render="regProposta:produtosPanelGrid"/>
			</h:commandLink>
		 </h:column>
      </h:dataTable>
      <!-- Modal -->
      <div id="myModalProdutosProposta" class="modal fade" role="dialog" >
			<div class="modal-dialog">
				<!-- Modal content-->
				<div class="modal-content" style="display:inline-block;">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">X</button>
						<h4 class="modal-title">Produtos</h4>
					</div>
					<div class="modal-body">
						<h:panelGrid id="produtosPanelGrid">
							<h:panelGroup rendered="#{empty newProposta.produtosModulosSelecionados}">
								<em>Nenhum produto registrado.</em>
							</h:panelGroup>
							<h:dataTable id="produtoPropostaDataTable" var="_produtoModulosSelecionados" value="#{newProposta.produtosModulosSelecionados}"
								rendered="#{not empty newProposta.produtosModulosSelecionados}" styleClass="table"
								headerClass="table-header" rowClasses="table-odd-row,table-even-row">
								<h:column>
									<f:facet name="header">Id</f:facet>
						               <h:outputText value="#{_produtoModulosSelecionados.produto.id}"/>
						           </h:column>
								 <h:column>
									<f:facet name="header">Descrição</f:facet>
						               <h:outputText value="#{_produtoModulosSelecionados.produto.descricao}"/>
						           </h:column>
						           <h:column>
									<f:facet name="header">Tipo contratação</f:facet>
						               <h:outputText value="#{_produtoModulosSelecionados.tipoContratacao.descricao}"/>
						           </h:column>
						           <h:column>
									<f:facet name="header">Quantidade</f:facet>
						               <h:outputText value="#{_produtoModulosSelecionados.quantidade}"/>
						           </h:column>
						           <h:column>
									<f:facet name="header">Valor unitatio</f:facet>
						               <h:outputText value="#{_produtoModulosSelecionados.valorUnitario}"/>
						           </h:column>
						           <h:column>
									<f:facet name="header">Valor total</f:facet>
						               <h:outputText value="#{_produtoModulosSelecionados.valorTotal}"/>
						           </h:column>
						           <h:column>
						           	<f:facet name="header"></f:facet>
						                <h:commandLink id="modulosDoProdutoPropostaCommandLink" value="Modulos" action="#{salvarProposta.setProdutoModulosSelecionados(_produtoModulosSelecionados)}" onclick="javascript:modalModulosDoProdutoProposta()">
						                	<f:ajax render="modulosDoProdutoPropostaPanelGrid"/>
						                </h:commandLink>
						           </h:column>
							</h:dataTable>
						</h:panelGrid>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
					</div>
				</div>
			</div>
		</div>
		</h:form>
      	<!-- Modal -->
		<div id="myModalLeadProposta" class="modal fade" role="dialog">
			<div class="modal-dialog">
				<!-- Modal content-->
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">X</button>
						<h4 class="modal-title">Selecione a Lead</h4>
					</div>
					<div class="modal-body">
						<h:panelGroup rendered="#{empty leads}">
							<em>Nenhum lead registrado.</em>
						</h:panelGroup>
						<h:dataTable id="leadsDataTable" var="_lead" value="#{leads}"
							rendered="#{not empty leads}" styleClass="table"
							headerClass="table-header" rowClasses="table-odd-row,table-even-row">
							<h:column>
								<f:facet name="header">Id</f:facet>
				                <h:outputText value="#{_lead.id}"/>
				            </h:column>
							<h:column>
								<f:facet name="header">Nome</f:facet>
				                <h:outputText value="#{_lead.nome}"/>
				            </h:column>
							<h:column>
								<f:facet name="header"></f:facet>
								<h:form>
									<h:commandLink value="Editar" action="#{salvarLead.editar(_lead)}" />
								</h:form>
							</h:column>
							<h:column>
								<f:facet name="header"></f:facet>
								<h:outputLink value="/crm/pages/protected/user/emailleads.xhtml">
									<h:outputText value="Email" />
								</h:outputLink>
							</h:column>
							<h:column>
								<f:facet name="header"></f:facet>
								<h:outputLink
									value="/crm/pages/protected/user/atividadeagenda.xhtml">
									<h:outputText value="Agenda" />
								</h:outputLink>
							</h:column>
						</h:dataTable>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary"
							onclick="javascript:selecionarLead()">Selecionar</button>
						<button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
					</div>
				</div>
			</div>
		</div>
		<!-- Modal -->
		<div id="myModalModulosDoProdutoProposta" class="modal fade" role="dialog">
			<div class="modal-dialog">
				<!-- Modal content-->
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">X</button>
						<h4 class="modal-title">Módulos do produto</h4>
					</div>
					<div class="modal-body">
						<h:panelGrid id="modulosDoProdutoPropostaPanelGrid">
							<h:panelGroup
								rendered="#{empty newProposta.produtoModulosSelecionados.modulosSelecionados}">
								<em>Nenhum módulo registrado.</em>
							</h:panelGroup>
							<h:dataTable id="modulosDoProdutoPropostaDataTable" var="_modulo"
								value="#{newProposta.produtoModulosSelecionados.modulosSelecionados}"
								rendered="#{not empty newProposta.produtoModulosSelecionados.modulosSelecionados}"
								width="100%" style="display:inline-table;" styleClass="table"
								headerClass="table-header"
								rowClasses="table-odd-row,table-even-row">
								<h:column>
									<f:facet name="header">Id</f:facet>
                					<h:outputText value="#{_modulo.modulo.id}"/>
            				</h:column>
								<h:column>
									<f:facet name="header">Descrição</f:facet>
               						<h:outputText value="#{_modulo.modulo.descricao}"/>
           					</h:column>
							</h:dataTable>
						</h:panelGrid>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
					</div>
				</div>
			</div>
		</div>
   </ui:define>
</ui:composition>